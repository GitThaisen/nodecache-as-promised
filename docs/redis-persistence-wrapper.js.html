<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>redis-persistence-wrapper.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<div id="main">
    
    <h1 class="page-title">redis-persistence-wrapper.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
  syncCacheWithRedis,
  scanKeys,
  createRegExp,
  isSerializable
} from './persistence-helpers.js'
import pkg from '../package.json'

const DEFAULT_EXPIRE = 60 * 60 * 24

/**
 * @description Create new instance
 * @param {Object} cacheInstance - an instance of CacheManager
 * @param {function} redisFactory - provides a redisClient with publish/subscribe features
 * @param {RegExp} options.doNotPersist - regexp-matching of keys that are not to peristed
 * @param {String} options.keySpace - Prefix to use for keys in redis
 * @param {number} options.expire - Keys stored in redis expire in seconds
 * @returns {Object} facade
 **/
export default (cacheInstance,
  redisFactory,
  {
    doNotPersist = null,
    keySpace = pkg.name,
    expire = DEFAULT_EXPIRE
  } = {}
) => {
  const redisClient = redisFactory()
  const cacheKeyPrefix = keySpace.replace(/https?|\/|:|\./g, '')
  const persisting = {}

  const get = (...args) => {
    return cacheInstance.get(...args).then((obj) => {
      const [key] = args
      if (obj.cache === 'miss' &amp;&amp; (!doNotPersist || !doNotPersist.test(key)) &amp;&amp; isSerializable(obj) &amp;&amp; !persisting[key]) {
        persisting[key] = true
        const redisKey = `${cacheKeyPrefix}-${Date.now()}${key}`
        cacheInstance.log.debug(`Persist to key "${redisKey}"`)
        redisClient.set(redisKey, JSON.stringify(cacheInstance.cache.get(key)), 'ex', expire, (err) => {
          if (err) {
            cacheInstance.log.warn(err)
          }
          delete persisting[key]
        })
      } else {
        cacheInstance.log.warn(`skipping persistence of promised object with key ${key}`)
      }
      return obj
    })
  }

  const re = createRegExp(cacheKeyPrefix)

  const load = () => {
    const then = Date.now()
    return new Promise((resolve, reject) => {
      scanKeys(redisClient, cacheKeyPrefix).then((keys) => {
        return syncCacheWithRedis({
          keys,
          regexp: re,
          maxLength: cacheInstance.maxLength,
          redisClient,
          log: cacheInstance.log
        }).then(([keysDeleted, mapLoaded]) => {
          return [
            keysDeleted,
            Object.keys(mapLoaded).map((key) => {
              cacheInstance.cache.set(key.replace(re, ''), mapLoaded[key])
              return key
            })
          ]
        }).then(([keysDeleted, keysLoaded]) => {
          resolve(`Deleted ${keysDeleted.length} keys, read ${keysLoaded.length} keys from redis. Used ${Date.now() - then} ms`)
        })
      }).catch(reject)
    })
  }

  const debug = (extraOptions) => {
    return cacheInstance.debug({cacheKeyPrefix, ...extraOptions})
  }

  return {
    ...cacheInstance,
    get,
    load,
    debug
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Dec 18 2017 10:18:36 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
