<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>redis-wrapper.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<div id="main">
    
    <h1 class="page-title">redis-wrapper.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import os from 'os'

const EXPIRE_MESSAGE_TYPE = 'EXPIRE_MESSAGE_TYPE'

/**
 * @description Create new instance
 * @param {Object} cacheInstance - an instance of CacheManager
 * @param {function} redisFactory - provides a redisClient with publish/subscribe features
 * @param {String} namespace - namespace to publish/subscribe messages (eg. http://desketoy:8080/)
 * @returns {Object} facade
 * @returns {function} object.get method
 * @returns {function} object.set method
 * @returns {function} object.expire method
 * @returns {function} object.debug method
 **/
export default (cacheInstance, redisFactory, namespace) => {
  const redisPub = redisFactory()
  const redisSubClient = redisFactory()

  /**
   * @description callback for messages recieved from redis
   * @param {String} namespace - namespace that were used to transmit message
   * @param {String} data - JSON-encoded message
   * @returns {undefined}
   **/
  const onMessage = (namespace, data) => {
    try {
      const {type, message} = JSON.parse(data)
      if (type === EXPIRE_MESSAGE_TYPE) {
        cacheInstance.log.info(`expire cache for keys ${message.keys} using namespace ${namespace} on host ${os.hostname()}`)
        cacheInstance.expire(message.keys)
      }
    } catch (e) {
      cacheInstance.log.error(`failed to parse message on ${namespace} - ${data}. Reason: ${e}`)
    }
  }

  /**
   * @description setup subscription to redis
   * @param {RedisClient} redisClient - a connected redisClient
   * @param {String} namespace - namespace to publish/subscribe messages (eg. http://desketoy:8080/)
   * @returns {undefined}
   **/
  const setupSubscriber = (redisClient, namespace) => {
    redisClient.subscribe(namespace, (err, cnt) => {
      if (err) {
        return cacheInstance.log.error(`oh oh. Subscribing for redis#${namespace} failed`)
      }
      return cacheInstance.log.debug(`Subscribing for incoming messages from redis#${namespace}. Count: ${cnt}`)
    })
    redisClient.on('message', onMessage)
  }

  /**
   * @description distributed wrapper for expire calls
   * @param {Array&lt;String>} keys - Array of keys. Accepts * as wildcards (converted to .*)
   * @returns {undefined}
   **/
  const expire = (keys) => {
    const message = {
      type: EXPIRE_MESSAGE_TYPE,
      message: {
        keys
      }
    }
    redisPub.publish(namespace, JSON.stringify(message))
  }

  const debug = (extraOptions) => {
    return cacheInstance.debug({namespace, ...extraOptions})
  }

  setupSubscriber(redisSubClient, namespace)

  return {
    ...cacheInstance,
    expire,
    debug
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Dec 18 2017 10:18:36 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
